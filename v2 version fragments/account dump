changename stuff:


local cur_player_id, del_player_id
	
	
	-- Get the current player id
	local sql = [[ SELECT player.id AS id
		       FROM player
		       JOIN player_name ON player.name = player_name.id
		       JOIN player_ip ON player.ip = player_ip.id
		       WHERE player_name.name = ']].. self:getName() ..[['
			     AND player_ip.ip = ']].. self:getIp() ..[[';]]
			     
	local result = db:query(sql)
	cur_player_id = tonumber(result[1].id)
	
	
	-- Get the player id of the new name if it exists
	local sql = [[ SELECT player.id AS id
		       FROM player
		       JOIN player_name ON player.name = player_name.id
		       JOIN player_ip ON player.ip = player_ip.id
		       WHERE player_name.name = ']].. new_name ..[['
		             AND player_ip.ip = ']].. self:getIp() ..[[';]]
		             
	result = db:query(sql)
	
	
	-- Delete other player entry that is a combination of ip/newname and link the records to the account. 
	-- This way a player can import all his records to his account if he wants to
	if result ~= nil then
		del_player_id = result[1].id
		
		
		-- link all records of the new name to the current player id
		local sql = [[ UPDATE record
			       SET player = ]].. cur_player_id ..[[
			       WHERE player = ]].. del_player_id ..[[;]]
			       
		db:query(sql)
		
		
		-- delete the player entry that contained the new name
		local sql = [[ DELETE FROM player
			       WHERE id = ]].. del_player_id ..[[;]]

		db:query(sql)
	else
	
	end
	
	
	-- Copy the old player entry (for the names log)
	local sql = [[ INSERT INTO player
		       (ip, name, level)
		        
		        -- Values
		       	SELECT ip, name, level
			FROM player
			WHERE id = ]].. cur_player_id ..[[;]]
			      
	db:query(sql)
